import openai
from rouge import Rouge
from nltk.translate import meteor_score
import nltk

def evaluate_summary(summary, reference):
    # Initialize Rouge and Meteor
    rouge = Rouge()

    # Download WordNet if not already downloaded, necessary for meteor
    nltk.download('wordnet', quiet=True) 

    # Tokenize the summary and reference
    tokenized_summary = summary.split()
    tokenized_reference = reference.split()

    # Compute ROUGE scores
    rouge_scores = rouge.get_scores(summary, reference)

    # Compute METEOR score
    meteor_scr = meteor_score.single_meteor_score(tokenized_reference, tokenized_summary)

    return rouge_scores, meteor_scr

openai.api_key = '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'
response = openai.ChatCompletion.create(
  model="gpt-3.5-turbo",
  messages=[
        {"role": "system", "content": "화자별 대화 요약을 생성하는 역할을 모델이다. 화자 별로 요약을 하되 각각 하나씩 요약을 생성하고, 원본 대본 데이터 내에 문맥과 전혀 상관이 없는 내용이 있으면 해당 내용은 무시한다."},
        #data 1
        {"role": "user", "content": """
        원본 대본 데이터)
        김경래]그런데 언론 보도를 보면 몇몇 분들의 이름이 거론이 됩니다. 예를 들어서 원희룡 제주지사 그리고 이준석 최고위원도 거론이 되고 진중권 교수 등등이 거론이 되는데 조경태 의원께서는 어떤 분이 됐으면 좋겠다, 어떤 분이 됐으면 좋겠다, 이런 생각 갖고 계시는 분이 있습니까?\n조경태]앞서 말씀드렸던 대로 이번에 비상대책위가 만약에 꾸려진다면 당을 수습해내는 수습대책위원회의 성격이거든요. 그리고 과거에 비대위가 제가 아까 말씀드렸던 대로 여러 차례 있었다고 하지 않았습니까? 며칠 전에 저한테 그중에 한 분이 오셔서 했던 분 중에 “의원님, 우리 당에는 이미 혁신안이 그 당시 다 나왔다. 그것을 실행만 하면 됩니다.” 이런 이야기를 하더라고요. 지금 이미 당을 혁신하는 비상대책위의 역할은 그동안 20대 국회에서 우리가 축적된 자료들이 있기 때문에 이번에 비상대책위는 수습대책위의 성격을 지니기 때문에 어떤 분이든 맡아서 전당 대회까지 당을 좀 더 수습해내는 그런 역할을 맡으시면 된다, 이런 생각을 합니다. 지금 거론하시는 분들 어떤 분이든 그런 역할을 맡기에는 역량이 충분하다, 이렇게 보고 있습니다.\n김경래]알겠습니다. 조기 전당 대회 열리면 한 언제쯤으로 예상하세요?\n조경태]지금 정상적으로 우리가 당헌당규를 보면 8월에 열도록 되어 있거든요. 아마 더불어 민주당 여당도 그즈음에 열리는 것으로 알고 있습니다. 저는 정상적인 전당 대회를 해도 좋을 것 같고요. 그리고 당을 수습한다는 시간적 여유를 준다는 그런 차원에서 그렇습니다. 그렇지 않으면 한두 달 앞당겨서 열어도 좋겠다. 그래서 9월이 정기국회이지 않습니까? 새롭게 출발한다는 의미에서 9월을 넘기지 않도록 하는 것이 좋겠다, 저는 제 입장은 그렇습니다.
        """},
        {"role": "assistant", "content": """
        화자별 요약)
        김경래:  비상대책위원회가 꾸려진다면 누가 역할을 맡기 좋겠냐고 물어보고, 전당대회가 언제 열릴것으로 예상하는지 물어본다. 
        조경태: 과거 비상대책위가 여러 차례가 있었던 바, 비상대책위가 꾸려진다면 수습대책위원회의 성격을 띌 것이라고 하고, 20대 국회에서 쌓인 자료들이 있기 때문에 언론 보도에서 거론된 원희룡, 이준석, 진중권 중 누구든 그 역할을 맡기에 역량이 충분한 것 같으니 9월 정기 국회를 넘기지 않도록 그 전에 정상적인 전당 대회를 열 수 있으면 좋을 것 같다고 답한다. 
        """},
        #data2
        {"role": "user", "content": """
        원본 대본 데이터)
        해설]일각.(전혀 다른 분위기의 스키장 주변에서 촬영하는 사진작가와 인영) \n현관 앞.(기사가 운전하는 재민의 차 와서 멈추고 재민 뒷자리에서 내려 조금 빠른 걸음으로 간다) \n휴게실.\n재민]...\n간병인](약간 주늑 든).\n재민]우리 집사람... 보살피기 힘드신 거 잘 알고 있습니다... 다른 환자이랑 많이 다르죠, 아주머님이 이해를 하시고 너그럽게 대해 주십쇼.\n간병인]저두... 어지간만 하면...\n재민]압니다, 그 사람 좀 특별합니다... 부탁 드릴께요, 어떤 경우에도 따뜻하게 대해 주세요.. 특별히 마음을 써 주십쇼, 몸 아픈 걸로도 힘든 사람이니까요.\n간병인](고개 떨군 체).\n재민]잘 좀 부탁 드립니다.\n간병인]죄송합니다.\n재민]아닙니다... (양복 주머니에서 봉투 꺼내 탁자위로 밀어준다).\n간병인](고개 들며?).\n재민]동생처럼 생각해 주십쇼...\n간병인]아, 아니예요..(얼른 붕투 민다).\n재민](다시 밀어주며) 부탁 드립니다.
        """},
        {"role": "assistant", "content": """
        화자별 요약)
        재민: 간병인에게 아내가 다른 환자와 많이 다르니 이해해달라고 한다. 몸 아픈 걸로도 힘든 사람이니 따뜻하게 대해 달라며 돈 봉투를 내민다. 
        간병인: 재민의 아내의 간병에 많이 힘들어하며, 돈 봉투를 받는 것에 대해 당황해한다.  
        """},
        
        #prompt
        {"role": "user", "content": """
        원본 대본 데이터)
        화자1]‘KBS스페셜’에서는 9일과 16일, 2주 연속으로 ‘치매’에 대한 특별한 다큐멘터리 주문을 잊는 음식점>을 방송합니다.\n화자2]한국은 이미 고령사회로 진입했고 현 정부는 보건복지정책 1호로 ‘치매국가책임제’를 선포하고 나섰습니다. ‘주무을 잊은 음식점’에서는 경증 치매 판정을 받은 70-80대 노인들이 음식점 서빙에 도전하는 과정을 담아냈습니다. 치매를 앓고 있는 사람들이 자신의 내밀한 이야기를 직접 들려주는 치매에 관한 순도 100% 리얼리티 프로그램이 탄생했습니다.\n화자1]지난 6월, 서울시 마포구 망원동에 요상한 음식점이 나타났습니다. 이름부터 특이한 ‘주문을 잊은 음식점’. 이 음식점은 세상에서 깜빡하는 것이 가장 자신 있는 경증 치매인 5인방이 서빙을 합니다. 주문한 음식이 나오지 않을 수도 있고 아예 다른 음식으로 나올 수도 있습니다. 그것은 순전히 서빙을 담당하는 경증 치매인들의 몫.\n화자2]‘주문을 잊은 음식점’은 경증 치매인들이 자발성과 독립성을 가지고 참여해 그들 스스로의 아이디어와 노력으로 탄생시킨 음식점입니다. 세상에 단 하나 뿐인 요상한 음식점의 리얼한 모습과 예상치 못한 돌발 상황들 그리고 음식점을 찾은 손님들의 반응으로 치매에 대한 모든 것을 알아봅니다. 이 곳에서는 과연 어떤 일들이 벌어졌을까?.\n화자1]KBS스페셜은 지난 3월, 서울 지역 26곳의 치매안심센터와 KBS 방송 스크롤을 통한 모집 공고로 ‘주문을 잊은 음식점’에 참가할 지원자를 모집했습니다. 이후 수많은 지원자들을 대상으로 심층 면접을 진행, 20:1의 높은 경쟁률을 뚫고 개성 넘치는 5인이 선발했습니다. 더 이상 수동적이고 비극적인 역할은 거부하겠다며 나선 이들은 음식점 준비 과정부터 개업, 영업종료까지 모든 과정에 적극 참여했습니다. 약 100일 동안 오로지 음식점만을 위해 생활한 이들이 느낀 기쁨과 슬픔, 후회, 두려움 등을 카메라에 생생하게 담았습니다.\n화자2]최근 ‘미다스의 손’이라 불리며 대세 행보를 이어가고 있는 개그우먼 송은이와 46년차 ‘중식의 대가’ 이연복 셰프가 치매인 5인방을 위해 든든한 조력자로 나섰습니다. 송은이는 경증 치매인들의 엉뚱한 실수에도 독특한 의미를 부여해 상황을 유쾌하게 넘기는 달, 이연복은 언제나 음식의 퀄리티를 최상급으로 유지시키는 믿고 먹는 명셰프로 함께했습니다.
        """}
    ],
  temperature=0.3,
  top_p=0.5,
  max_tokens =500
)

answer = response.choices[0].message.content
print(answer)

print("Used tokens:", response['usage']['total_tokens'])

reference_data = """
화자별 요약)
    화자1: 치매에 대한 특별한 다큐멘터리 주문을 잊는 음식점을 소개한다. 해당 다큐멘터리가 경증 치매인 5인방이 서빙을 하는 요상한 음식점에 대해서 다루고, 음식점 준비 과정부터 개업, 영업종료까지의 과정을 담았다는 것을 소개한다. 
    화자2: 주문을 잊은 음식점에 대해서 소개하고, 주문을 잊은 음식점의 조력자 개그우먼 송은이와 이연복 셰프에 대해서 소개한다. 
"""

r_scr, m_scr = evaluate_summary(answer, reference_data)
print(r_scr, m_scr)
